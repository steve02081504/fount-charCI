# fount-charCI

[![kho l∆∞u tr·ªØ fount](https://steve02081504.github.io/fount/badges/fount_repo.svg)](https://github.com/steve02081504/fount)

[![English (United Kingdom)](https://raw.githubusercontent.com/gosquared/flags/master/flags/flags/shiny/48/United-Kingdom.png)](./readme.en-UK.md)
[![Êó•Êú¨Ë™û](https://raw.githubusercontent.com/gosquared/flags/master/flags/flags/shiny/48/Japan.png)](./readme.ja-JP.md)
[![‰∏≠Êñá](https://raw.githubusercontent.com/gosquared/flags/master/flags/flags/shiny/48/China.png)](./readme.zh-CN.md)
[![Deutsch](https://raw.githubusercontent.com/gosquared/flags/master/flags/flags/shiny/48/Germany.png)](./readme.de-DE.md)
[![Espa√±ol](https://raw.githubusercontent.com/gosquared/flags/master/flags/flags/shiny/48/Spain.png)](./readme.es-ES.md)
[![Fran√ßais](https://raw.githubusercontent.com/gosquared/flags/master/flags/flags/shiny/48/France.png)](./readme.fr-FR.md)
[![‡§π‡§ø‡§®‡•ç‡§¶‡•Ä](https://raw.githubusercontent.com/gosquared/flags/master/flags/flags/shiny/48/India.png)](./readme.hi-IN.md)
[![Italiano](https://raw.githubusercontent.com/gosquared/flags/master/flags/flags/shiny/48/Italy.png)](./readme.it-IT.md)
[![ÌïúÍµ≠Ïñ¥](https://raw.githubusercontent.com/gosquared/flags/master/flags/flags/shiny/48/South-Korea.png)](./readme.ko-KR.md)
[![Portugu√™s (Brasil)](https://raw.githubusercontent.com/gosquared/flags/master/flags/flags/shiny/48/Brazil.png)](./readme.pt-BR.md)
[![–†—É—Å—Å–∫–∏–π](https://raw.githubusercontent.com/gosquared/flags/master/flags/flags/shiny/48/Russia.png)](./readme.ru-RU.md)
[![Ti·∫øng Vi·ªát](https://raw.githubusercontent.com/gosquared/flags/master/flags/flags/shiny/48/Vietnam.png)](./readme.vi-VN.md)

M·ªôt c√¥ng c·ª• T√≠ch h·ª£p Li√™n t·ª•c (CI) ng·∫Øn g·ªçn nh∆∞ng m·∫°nh m·∫Ω, ƒë∆∞·ª£c thi·∫øt k·∫ø ƒë·∫∑c bi·ªát cho c√°c nh√† ph√°t tri·ªÉn vai tr√≤ [fount](https://github.com/steve02081504/fount) ƒë·ªÉ t·ª± ƒë·ªông h√≥a th·ª≠ nghi·ªám v√† ƒë·∫£m b·∫£o vai tr√≤ c·ªßa b·∫°n ch·∫°y ·ªïn ƒë·ªãnh.

N√≥ gi√∫p b·∫°n ph√°t hi·ªán c√°c l·ªói ·ªü c·∫•p ƒë·ªô m√£ nh∆∞ s·ª± c·ªë c√∫ ph√°p, l·ªánh g·ªçi API kh√¥ng th√†nh c√¥ng v√† c√°c ngo·∫°i l·ªá trong ch·ª©c nƒÉng c√¥ng c·ª•, nh·ªù ƒë√≥ ƒë·∫£m b·∫£o kh·∫£ nƒÉng s·ª≠ d·ª•ng c∆° b·∫£n c·ªßa vai tr√≤ c·ªßa b·∫°n tr∆∞·ªõc khi ph√°t h√†nh v√† ngƒÉn ch·∫∑n c√°c l·ªói nh·ªè ·∫£nh h∆∞·ªüng ƒë·∫øn tr·∫£i nghi·ªám ng∆∞·ªùi d√πng.

## ‚ú® T√≠nh nƒÉng

C√¥ng c·ª• CI n√†y t·∫≠p trung v√†o vi·ªác ki·ªÉm tra t√≠nh m·∫°nh m·∫Ω v·ªÅ m·∫∑t l·∫≠p tr√¨nh c·ªßa vai tr√≤ c·ªßa b·∫°n, ch·ªß y·∫øu bao g·ªìm c√°c lƒ©nh v·ª±c sau:

- ‚úÖ **Ki·ªÉm tra c√≥ c·∫•u tr√∫c**: S·∫Øp x·∫øp c√°c tr∆∞·ªùng h·ª£p th·ª≠ nghi·ªám c·ªßa b·∫°n b·∫±ng c√°ch s·ª≠ d·ª•ng c√°c kh·ªëi `test` gi·ªëng nh∆∞ Jest, v·ªõi s·ª± h·ªó tr·ª£ cho m·ªçi c·∫•p ƒë·ªô l·ªìng gh√©p, gi√∫p t·∫≠p l·ªánh th·ª≠ nghi·ªám c·ªßa b·∫°n r√µ r√†ng v√† d·ªÖ ƒë·ªçc.
- ‚úÖ **Ki·ªÉm tra ƒë·ªìng th·ªùi & tu·∫ßn t·ª±**: H·ªó tr·ª£ ch·∫°y th·ª≠ nghi·ªám song song ƒë·ªÉ tƒÉng t·ªëc ƒë·ªô ho·∫∑c ƒë·∫£m b·∫£o th·ª±c hi·ªán tu·∫ßn t·ª± b·∫±ng `await`.
- ‚úÖ **Hook ki·ªÉm tra**: Cung c·∫•p c√°c h√†m hook `beforeAll`, `afterAll`, `beforeEach` v√† `afterEach` ƒë·ªÉ thi·∫øt l·∫≠p v√† g·ª° b·ªè m√¥i tr∆∞·ªùng ·ªü c√°c giai ƒëo·∫°n kh√°c nhau c·ªßa v√≤ng ƒë·ªùi th·ª≠ nghi·ªám.
- ‚úÖ **M√¥i tr∆∞·ªùng th·ª≠ nghi·ªám bi·ªát l·∫≠p**: M·ªói th·ª≠ nghi·ªám c√≥ kh√¥ng gian l√†m vi·ªác ƒë·ªôc l·∫≠p, ƒë∆∞·ª£c d·ªçn d·∫πp t·ª± ƒë·ªông (cho c√°c thao t√°c t·ªáp) v√† b·ªô ƒë·ªãnh tuy·∫øn HTTP, ngƒÉn ch·∫∑n s·ª± giao thoa gi·ªØa c√°c th·ª≠ nghi·ªám.
- ‚úÖ **ƒêi·ªÅu khi·ªÉn b·∫±ng kh·∫≥ng ƒë·ªãnh**: X√°c minh k·∫øt qu·∫£ th·ª≠ nghi·ªám b·∫±ng h√†m `assert`, b√°o c√°o th√¥ng b√°o l·ªói r√µ r√†ng khi th·∫•t b·∫°i.
- ‚úÖ **M√¥ ph·ªèng t∆∞∆°ng t√°c nhi·ªÅu b∆∞·ªõc**: M√¥ ph·ªèng ch√≠nh x√°c lu·ªìng ho√†n ch·ªânh "suy nghƒ© -> s·ª≠ d·ª•ng c√¥ng c·ª• -> ph·∫£n h·ªìi" c·ªßa AI, ki·ªÉm tra logic `replyHandler` ph·ª©c t·∫°p.
- ‚úÖ **Ki·ªÉm tra nh·∫≠t k√Ω h·ªá th·ªëng & l·ªùi nh·∫Øc**: C√≥ kh·∫£ nƒÉng ki·ªÉm tra th√¥ng tin c·∫•p h·ªá th·ªëng ƒë∆∞·ª£c tr·∫£ v·ªÅ AI sau khi th·ª±c hi·ªán c√¥ng c·ª• v√† th·∫≠m ch√≠ truy xu·∫•t l·ªùi nh·∫Øc cu·ªëi c√πng ƒë∆∞·ª£c g·ª≠i ƒë·∫øn AI, ƒë·∫£m b·∫£o logic v√† x·ª≠ l√Ω d·ªØ li·ªáu nh∆∞ mong ƒë·ª£i.
- ‚úÖ **B√°o c√°o th·ª≠ nghi·ªám chi ti·∫øt**: T·ª± ƒë·ªông t·∫°o c√°c b√°o c√°o t√≥m t·∫Øt th·ª≠ nghi·ªám t∆∞∆°ng t√°c, ƒë·∫πp m·∫Øt trong GitHub Actions, bao g·ªìm th·ªùi l∆∞·ª£ng, nh·∫≠t k√Ω v√† chi ti·∫øt l·ªói cho m·ªói th·ª≠ nghi·ªám.

> V·ªõi b·∫£n ch·∫•t kh√¥ng x√°c ƒë·ªãnh c·ªßa n·ªôi dung do LLM t·∫°o ra, c√¥ng c·ª• n√†y **kh√¥ng th·ªÉ** ƒë√°nh gi√° ch·∫•t l∆∞·ª£ng c·ªßa l·ªùi nh·∫Øc ho·∫∑c gi√° tr·ªã c·ªßa n·ªôi dung do AI t·∫°o ra. Gi√° tr·ªã c·ªët l√µi c·ªßa n√≥ n·∫±m ·ªü vi·ªác ƒë·∫£m b·∫£o t√≠nh ƒë√∫ng ƒë·∫Øn c·ªßa c√°c ph·∫ßn l·∫≠p tr√¨nh c·ªßa vai tr√≤.

## üöÄ B·∫Øt ƒë·∫ßu nhanh

Thi·∫øt l·∫≠p th·ª≠ nghi·ªám t·ª± ƒë·ªông cho d·ª± √°n vai tr√≤ fount c·ªßa b·∫°n ch·ªâ trong ba b∆∞·ªõc.

### B∆∞·ªõc 1: T·∫°o t·ªáp quy tr√¨nh l√†m vi·ªác

Trong th∆∞ m·ª•c g·ªëc c·ªßa d·ª± √°n vai tr√≤ c·ªßa b·∫°n, h√£y t·∫°o t·ªáp c·∫•u h√¨nh CI: `.github/workflows/CI.yml`.

### B∆∞·ªõc 2: ƒêi·ªÅn v√†o m·∫´u

D√°n n·ªôi dung sau v√†o t·ªáp `CI.yml`. N√≥ s·∫Ω t·ª± ƒë·ªông ch·∫°y th·ª≠ nghi·ªám khi ƒë·∫©y m√£.

```yaml
name: Test Running

permissions:
  contents: read
  actions: write # B·∫Øt bu·ªôc ƒë·ªÉ c·∫≠p nh·∫≠t b·ªô ƒë·ªám ·∫©n

on:
  # Cho ph√©p k√≠ch ho·∫°t th·ªß c√¥ng
  workflow_dispatch:
  # T·ª± ƒë·ªông k√≠ch ho·∫°t khi t·ªáp .mjs thay ƒë·ªïi
  push:
    paths:
      - '**.mjs'
    # B·ªè qua c√°c l·∫ßn ƒë·∫©y th·∫ª ƒë·ªÉ tr√°nh k√≠ch ho·∫°t khi ph√°t h√†nh phi√™n b·∫£n
    tags-ignore:
      - '*'
    # Cho ph√©p ƒë·∫©y t·ª´ b·∫•t k·ª≥ nh√°nh n√†o
    branches:
      - '*'

jobs:
  test-running:
    runs-on: ubuntu-latest
    steps:
      - uses: steve02081504/fount-charCI@master
        with:
          # Ch·ªâ ƒë·ªãnh ƒë∆∞·ªùng d·∫´n ƒë·∫øn t·∫≠p l·ªánh th·ª≠ nghi·ªám CI c·ªßa b·∫°n
          CI-filepath: .github/workflows/CI.mjs
          # (T√πy ch·ªçn) Ch·ªâ ƒë·ªãnh t√™n ng∆∞·ªùi d√πng cho CI, m·∫∑c ƒë·ªãnh l√† "CI-user"
          # CI-username: my-ci-user
```

### B∆∞·ªõc 3: T·∫°o t·∫≠p l·ªánh th·ª≠ nghi·ªám CI

Trong th∆∞ m·ª•c g·ªëc c·ªßa d·ª± √°n vai tr√≤ c·ªßa b·∫°n, h√£y t·∫°o t·ªáp nh·∫≠p CI: `.github/workflows/CI.mjs`. D∆∞·ªõi ƒë√¢y l√† m·ªôt m·∫´u th·ª≠ nghi·ªám c∆° b·∫£n, hi·ªán ƒë·∫°i:

```javascript
// fountCharCI ƒë∆∞·ª£c t·ª± ƒë·ªông ƒë∆∞a v√†o ph·∫°m vi to√†n c·ª•c v√† c√≥ th·ªÉ ƒë∆∞·ª£c s·ª≠ d·ª•ng tr·ª±c ti·∫øp
const CI = fountCharCI;

// --- Tr∆∞·ªùng h·ª£p th·ª≠ nghi·ªám 1: X·ª≠ l√Ω d·ª± ph√≤ng kh√¥ng c√≥ ngu·ªìn AI ---
await CI.test('noAI Fallback', async () => {
	// X√≥a ngu·ªìn AI ƒë·ªÉ ki·ªÉm tra tr√¨nh x·ª≠ l√Ω d·ª± ph√≤ng
	await CI.char.interfaces.config.SetData({ AIsource: '' });
	// runOutput kh√¥ng c√≥ ƒë·ªëi s·ªë m√¥ ph·ªèng m·ªôt y√™u c·∫ßu tr·ªëng ho·∫∑c m·∫∑c ƒë·ªãnh
	await CI.runOutput();
	// N·∫øu kh√¥ng c√≥ l·ªói n√†o ƒë∆∞·ª£c ƒë∆∞a ra, th·ª≠ nghi·ªám s·∫Ω th√†nh c√¥ng
});

// --- Tr∆∞·ªùng h·ª£p th·ª≠ nghi·ªám 2: Cu·ªôc tr√≤ chuy·ªán AI c∆° b·∫£n ---
await CI.test('Basic AI Response', async () => {
	// ƒê·∫£m b·∫£o ngu·ªìn AI ƒë∆∞·ª£c ƒë·∫∑t
	await CI.char.interfaces.config.SetData({ AIsource: 'CI' });

	// M√¥ ph·ªèng ƒë·∫ßu v√†o c·ªßa ng∆∞·ªùi d√πng "Xin ch√†o" v√† ki·ªÉm tra n·ªôi dung cu·ªëi c√πng ƒë∆∞·ª£c tr·∫£ v·ªÅ b·ªüi vai tr√≤
	const { reply } = await CI.runInput('Xin ch√†o');

	// Kh·∫≥ng ƒë·ªãnh r·∫±ng ƒë·∫ßu ra cu·ªëi c√πng c·ªßa vai tr√≤ kh·ªõp v·ªõi nh·ªØng g√¨ ngu·ªìn AI tr·∫£ v·ªÅ
	// Ngu·ªìn AI gi·∫£ l·∫≠p CI m·∫∑c ƒë·ªãnh tr·∫£ v·ªÅ "N·∫øu t√¥i kh√¥ng bao gi·ªù g·∫∑p l·∫°i b·∫°n, ch√†o bu·ªïi s√°ng, ch√†o bu·ªïi chi·ªÅu v√† ch√∫c ng·ªß ngon."
	CI.assert(reply.content.includes('ch√†o bu·ªïi s√°ng'), 'Nh√¢n v·∫≠t kh√¥ng tr·∫£ v·ªÅ ch√≠nh x√°c n·ªôi dung AI.');
});
```

Sau khi ho√†n th√†nh c√°c b∆∞·ªõc n√†y, quy tr√¨nh th·ª≠ nghi·ªám s·∫Ω t·ª± ƒë·ªông ch·∫°y m·ªói khi b·∫°n ƒë·∫©y b·∫£n c·∫≠p nh·∫≠t t·ªáp `.mjs` v√†o kho l∆∞u tr·ªØ GitHub c·ªßa m√¨nh.

## üìñ Tham chi·∫øu API CI

`fount-charCI` cung c·∫•p m·ªôt API ng·∫Øn g·ªçn nh∆∞ng m·∫°nh m·∫Ω ƒë·ªÉ x√¢y d·ª±ng c√°c th·ª≠ nghi·ªám c·ªßa b·∫°n.

### X√°c ƒë·ªãnh th·ª≠ nghi·ªám

#### `CI.test(name, asyncFn, options)`

X√°c ƒë·ªãnh m·ªôt kh·ªëi th·ª≠ nghi·ªám. N√≥ c√≥ th·ªÉ l√† m·ªôt th·ª≠ nghi·ªám c·∫•p cao nh·∫•t ho·∫∑c ƒë∆∞·ª£c l·ªìng trong c√°c kh·ªëi `test` kh√°c ƒë·ªÉ t·∫°o th√†nh c√°c th·ª≠ nghi·ªám con.

- `name` (Chu·ªói): M√¥ t·∫£ v·ªÅ th·ª≠ nghi·ªám.
- `asyncFn` (H√†m): M·ªôt h√†m kh√¥ng ƒë·ªìng b·ªô ch·ª©a logic th·ª≠ nghi·ªám.
- `options` (ƒê·ªëi t∆∞·ª£ng, T√πy ch·ªçn): C√°c t√πy ch·ªçn c·∫•u h√¨nh cho h√†nh vi c·ªßa th·ª≠ nghi·ªám.
  - `start_emoji` (Chu·ªói): Bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c ƒë∆∞·ª£c hi·ªÉn th·ªã khi th·ª≠ nghi·ªám b·∫Øt ƒë·∫ßu. M·∫∑c ƒë·ªãnh l√† `üß™`.
  - `success_emoji` (Chu·ªói): Bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c ƒë∆∞·ª£c hi·ªÉn th·ªã khi th·ª≠ nghi·ªám th√†nh c√¥ng. M·∫∑c ƒë·ªãnh l√† `‚úÖ`.
  - `fail_emoji` (Chu·ªói): Bi·ªÉu t∆∞·ª£ng c·∫£m x√∫c ƒë∆∞·ª£c hi·ªÉn th·ªã khi th·ª≠ nghi·ªám th·∫•t b·∫°i. M·∫∑c ƒë·ªãnh l√† `‚ùå`.

#### Ki·ªÉm tra ƒë·ªìng th·ªùi & tu·∫ßn t·ª±

`CI.test` tr·∫£ v·ªÅ m·ªôt ƒë·ªëi t∆∞·ª£ng gi·ªëng nh∆∞ Promise, gi√∫p vi·ªác ki·ªÉm so√°t lu·ªìng th·ª±c thi tr·ªü n√™n r·∫•t ƒë∆°n gi·∫£n.

- **Th·ª±c thi tu·∫ßn t·ª±**: S·ª≠ d·ª•ng `await` khi g·ªçi `CI.test` n·∫øu b·∫°n mu·ªën c√°c th·ª≠ nghi·ªám ch·∫°y l·∫ßn l∆∞·ª£t theo th·ª© t·ª±.
- **Th·ª±c thi ƒë·ªìng th·ªùi**: B·∫°n c√≥ th·ªÉ g·ªçi nhi·ªÅu th·ª≠ nghi·ªám ƒë·ªôc l·∫≠p m√† kh√¥ng c·∫ßn `await` ƒë·ªÉ ch√∫ng ch·∫°y song song.

### Hook ki·ªÉm tra

C√°c h√†m n√†y cho ph√©p b·∫°n th·ª±c thi m√£ ·ªü c√°c ƒëi·ªÉm kh√°c nhau trong v√≤ng ƒë·ªùi th·ª≠ nghi·ªám, l√Ω t∆∞·ªüng ƒë·ªÉ thi·∫øt l·∫≠p v√† g·ª° b·ªè c√°c m√¥i tr∆∞·ªùng th·ª≠ nghi·ªám d√πng chung.

- `CI.beforeAll(asyncFn)`: Ch·∫°y m·ªôt l·∫ßn tr∆∞·ªõc t·∫•t c·∫£ c√°c th·ª≠ nghi·ªám trong ph·∫°m vi hi·ªán t·∫°i (trong m·ªôt kh·ªëi `test`).
- `CI.afterAll(asyncFn)`: Ch·∫°y m·ªôt l·∫ßn sau khi t·∫•t c·∫£ c√°c th·ª≠ nghi·ªám trong ph·∫°m vi hi·ªán t·∫°i ƒë√£ k·∫øt th√∫c.
- `CI.beforeEach(asyncFn)`: Ch·∫°y tr∆∞·ªõc m·ªói th·ª≠ nghi·ªám trong ph·∫°m vi hi·ªán t·∫°i.
- `CI.afterEach(asyncFn)`: Ch·∫°y sau khi m·ªói th·ª≠ nghi·ªám trong ph·∫°m vi hi·ªán t·∫°i ƒë√£ k·∫øt th√∫c.

```javascript
// V√≠ d·ª•: S·ª≠ d·ª•ng hook v√† d·ªØ li·ªáu ng·ªØ c·∫£nh ƒë·ªÉ qu·∫£n l√Ω c∆° s·ªü d·ªØ li·ªáu gi·∫£ l·∫≠p
CI.test('Ki·ªÉm tra v·ªõi c∆° s·ªü d·ªØ li·ªáu d√πng chung', async () => {
	CI.beforeAll(() => {
		console.log('ƒêang kh·ªüi t·∫°o c∆° s·ªü d·ªØ li·ªáu gi·∫£ l·∫≠p...');
		// S·ª≠ d·ª•ng ƒë·ªëi t∆∞·ª£ng context.data ƒë·ªÉ l∆∞u tr·ªØ c√°c t√†i nguy√™n d√πng chung trong ph·∫°m vi
		CI.context.data.mockDB = { users: { 'steve': { visits: 0 } } };
	});

	CI.afterAll(() => {
		const finalCount = CI.context.data.mockDB.users.steve.visits;
		console.log(`Ki·ªÉm tra c∆° s·ªü d·ªØ li·ªáu ho√†n t·∫•t. S·ªë l∆∞·ª£t truy c·∫≠p cu·ªëi c√πng: ${finalCount}`);
	});

	CI.test('L∆∞·ª£t truy c·∫≠p c·ªßa ng∆∞·ªùi d√πng tƒÉng b·ªô ƒë·∫øm', () => {
		CI.context.data.mockDB.users.steve.visits++;
		CI.assert(CI.context.data.mockDB.users.steve.visits > 0, 'S·ªë l∆∞·ª£t truy c·∫≠p ph·∫£i l·ªõn h∆°n 0');
	});
});
```

### Ng·ªØ c·∫£nh th·ª≠ nghi·ªám

#### `CI.context`

M·ªôt ƒë·ªëi t∆∞·ª£ng k·ª≥ di·ªáu cung c·∫•p quy·ªÅn truy c·∫≠p v√†o m√¥i tr∆∞·ªùng bi·ªát l·∫≠p c·ªßa **th·ª≠ nghi·ªám hi·ªán t·∫°i**.

- `CI.context.workSpace`:
  - `path` (Chu·ªói): ƒê∆∞·ªùng d·∫´n tuy·ªát ƒë·ªëi ƒë·∫øn th∆∞ m·ª•c l√†m vi·ªác duy nh·∫•t c·ªßa th·ª≠ nghi·ªám hi·ªán t·∫°i.
- `CI.context.http`:
  - `router` (B·ªô ƒë·ªãnh tuy·∫øn Express): M·ªôt phi√™n b·∫£n b·ªô ƒë·ªãnh tuy·∫øn Express d√†nh ri√™ng cho th·ª≠ nghi·ªám n√†y.
  - `url` (Chu·ªói): URL ƒë·∫ßy ƒë·ªß ƒë·ªÉ truy c·∫≠p b·ªô ƒë·ªãnh tuy·∫øn chuy√™n d·ª•ng c·ªßa th·ª≠ nghi·ªám n√†y.
- `CI.context.data` (ƒê·ªëi t∆∞·ª£ng): M·ªôt ƒë·ªëi t∆∞·ª£ng tr·ªëng ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ truy·ªÅn d·ªØ li·ªáu gi·ªØa c√°c hook c·ªßa th·ª≠ nghi·ªám v√† ph·∫ßn th√¢n c·ªßa n√≥.

### M√¥ ph·ªèng t∆∞∆°ng t√°c

#### `CI.runInput(input, request)`

M√¥ ph·ªèng m·ªôt **ng∆∞·ªùi d√πng g·ª≠i tin nh·∫Øn** cho vai tr√≤.

- `input` (Chu·ªói | ƒê·ªëi t∆∞·ª£ng): ƒê·∫ßu v√†o c·ªßa ng∆∞·ªùi d√πng.
- `request` (ƒê·ªëi t∆∞·ª£ng, T√πy ch·ªçn): M·ªôt ƒë·ªëi t∆∞·ª£ng y√™u c·∫ßu m·ªôt ph·∫ßn ƒë·ªÉ ghi ƒë√® c√°c tham s·ªë y√™u c·∫ßu m·∫∑c ƒë·ªãnh.
- **Tr·∫£ v·ªÅ** (ƒê·ªëi t∆∞·ª£ng): M·ªôt ƒë·ªëi t∆∞·ª£ng ch·ª©a th√¥ng tin g·ª° l·ªói chi ti·∫øt:
  - `reply` (ƒê·ªëi t∆∞·ª£ng): K·∫øt qu·∫£ cu·ªëi c√πng ƒë∆∞·ª£c tr·∫£ v·ªÅ b·ªüi `GetReply` c·ªßa vai tr√≤.
  - `prompt_struct` (ƒê·ªëi t∆∞·ª£ng): L·ªùi nh·∫Øc c√≥ c·∫•u tr√∫c ƒë∆∞·ª£c g·ª≠i ƒë·∫øn AI.
  - `prompt_single` (Chu·ªói): L·ªùi nh·∫Øc ƒë∆∞·ª£c g·ª≠i ƒë·∫øn AI, ƒë∆∞·ª£c chuy·ªÉn ƒë·ªïi th√†nh m·ªôt chu·ªói duy nh·∫•t.

#### `CI.runOutput(output, request)`

M√¥ ph·ªèng **ƒë·∫ßu ra c·ªßa AI** ƒë·ªÉ ki·ªÉm tra `replyHandler` c·ªßa vai tr√≤.

- `output` (Chu·ªói | M·∫£ng | H√†m): N·ªôi dung m√¥ ph·ªèng ƒë∆∞·ª£c tr·∫£ v·ªÅ b·ªüi AI.
  - **Chu·ªói**: M√¥ ph·ªèng AI tr·∫£ v·ªÅ tr·ª±c ti·∫øp chu·ªói n√†y.
  - **M·∫£ng**: M√¥ ph·ªèng m·ªôt t∆∞∆°ng t√°c nhi·ªÅu b∆∞·ªõc. M·ªói ph·∫ßn t·ª≠ trong m·∫£ng, c√≥ th·ªÉ l√† m·ªôt chu·ªói ho·∫∑c m·ªôt h√†m, ƒë∆∞·ª£c s·ª≠ d·ª•ng tu·∫ßn t·ª± l√†m gi√° tr·ªã tr·∫£ v·ªÅ c·ªßa AI.
  - **H√†m**: T·ª± ƒë·ªông t·∫°o ƒë·∫ßu ra c·ªßa AI.
    - **Kh√¥ng ƒë·ªìng b·ªô**: H√†m c√≥ th·ªÉ l√† `async`.
    - **Tham s·ªë**: H√†m nh·∫≠n m·ªôt ƒë·ªëi t∆∞·ª£ng `result` ch·ª©a `prompt_single` v√† `prompt_struct` l√†m ƒë·ªëi s·ªë c·ªßa n√≥.
    - **Gi√° tr·ªã tr·∫£ v·ªÅ**: Gi√° tr·ªã tr·∫£ v·ªÅ c·ªßa h√†m tr·ªü th√†nh ƒë·∫ßu ra **ti·∫øp theo** c·ªßa AI trong chu·ªói.
    - **Tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng**: ƒêi·ªÅu n√†y c·ª±c k·ª≥ h·ªØu √≠ch ƒë·ªÉ ƒë∆∞a ra c√°c kh·∫≥ng ƒë·ªãnh ho·∫∑c th·ª±c hi·ªán logic ph·ª©c t·∫°p gi·ªØa m·ªôt t∆∞∆°ng t√°c nhi·ªÅu b∆∞·ªõc.

- `request` (ƒê·ªëi t∆∞·ª£ng, T√πy ch·ªçn): T∆∞∆°ng t·ª± nh∆∞ `CI.runInput`.
- **Tr·∫£ v·ªÅ** (ƒê·ªëi t∆∞·ª£ng): K·∫øt qu·∫£ cu·ªëi c√πng t·ª´ `GetReply` c·ªßa vai tr√≤.

#### ƒê·ªëi t∆∞·ª£ng `result`

Gi√° tr·ªã tr·∫£ v·ªÅ c·ªßa c√°c h√†m t∆∞∆°ng t√°c (ho·∫∑c thu·ªôc t√≠nh `reply` c·ªßa ch√∫ng) b·∫Øt ngu·ªìn t·ª´ gi√° tr·ªã tr·∫£ v·ªÅ `GetReply` c·ªßa vai tr√≤ v√† th∆∞·ªùng bao g·ªìm:

- **`content`** (Chu·ªói): N·ªôi dung vƒÉn b·∫£n cu·ªëi c√πng ƒë∆∞·ª£c tr√¨nh b√†y cho ng∆∞·ªùi d√πng.
- **`logContextBefore`** (M·∫£ng|Kh√¥ng x√°c ƒë·ªãnh): M·ªôt m·∫£ng c√°c nh·∫≠t k√Ω tin nh·∫Øn ghi l·∫°i t·∫•t c·∫£ l·ªãch s·ª≠ tr∆∞·ªõc khi `content` cu·ªëi c√πng ƒë∆∞·ª£c t·∫°o, bao g·ªìm c√°c tin nh·∫Øn c√≥ vai tr√≤ `tool` (k·∫øt qu·∫£ th·ª±c hi·ªán c√¥ng c·ª•), vai tr√≤ `user` v√† vai tr√≤ `char`.

### C√¥ng c·ª• ti·ªán √≠ch

- `CI.assert(condition, message)`: Th·ª±c hi·ªán m·ªôt kh·∫≥ng ƒë·ªãnh.
- `CI.char`: M·ªôt l·ªëi t·∫Øt ƒë·ªÉ truy c·∫≠p ƒë·ªëi t∆∞·ª£ng phi√™n b·∫£n vai tr√≤ hi·ªán ƒë∆∞·ª£c t·∫£i.
- `CI.sleep(ms)`: T·∫°m d·ª´ng th·ª±c thi trong s·ªë mili gi√¢y ƒë∆∞·ª£c ch·ªâ ƒë·ªãnh.
- `CI.wait(fn, timeout)`: ThƒÉm d√≤ h√†m `fn` cho ƒë·∫øn khi n√≥ tr·∫£ v·ªÅ m·ªôt gi√° tr·ªã ƒë√∫ng ho·∫∑c h·∫øt th·ªùi gian ch·ªù.

## üí° S·ª≠ d·ª•ng n√¢ng cao

### Ki·ªÉm tra c√°c h√†m thao t√°c t·ªáp

B·∫°n c√≥ th·ªÉ ki·ªÉm tra m·ªôt c√°ch an to√†n c√°c h√†m ƒë·ªçc v√† ghi t·ªáp b·∫±ng c√°ch s·ª≠ d·ª•ng `CI.context.workSpace`.

**V√≠ d·ª•:** Ki·ªÉm tra h√†m `<run-bash>`.

```javascript
import fs from 'node:fs';
import path from 'node:path';
const CI = fountCharCI;

CI.beforeEach(async () => {
	await CI.char.interfaces.config.SetData({ AIsource: 'CI' });
});

CI.test('H√†m: <run-bash>', async () => {
	// S·ª≠ d·ª•ng ƒë∆∞·ªùng d·∫´n kh√¥ng gian l√†m vi·ªác bi·ªát l·∫≠p
	const testDir = path.join(CI.context.workSpace.path, 'bash_test_dir');

	const result = await CI.runOutput([
		`<run-bash>mkdir ${testDir}</run-bash>`,
		'Th∆∞ m·ª•c ƒë√£ ƒë∆∞·ª£c t·∫°o.'
	]);

	CI.assert(fs.existsSync(testDir), '<run-bash> kh√¥ng t·∫°o ƒë∆∞·ª£c th∆∞ m·ª•c.');
	CI.assert(result.content === 'Th∆∞ m·ª•c ƒë√£ ƒë∆∞·ª£c t·∫°o.', 'Tin nh·∫Øn cu·ªëi c√πng kh√¥ng ch√≠nh x√°c.');
});
```

### Ki·ªÉm tra duy·ªát web (v·ªõi c√°c kh·∫≥ng ƒë·ªãnh b∆∞·ªõc trung gian)

B·∫°n c√≥ th·ªÉ x√¢y d·ª±ng c√°c th·ª≠ nghi·ªám t∆∞∆°ng t√°c m·∫°ng ph·ª©c t·∫°p b·∫±ng c√°ch s·ª≠ d·ª•ng `CI.context.http` v√† ƒë·ªëi s·ªë h√†m c·ªßa `runOutput`.

**V√≠ d·ª•:** Ki·ªÉm tra h√†m `<web-browse>` v√† x√°c th·ª±c n·ªôi dung l·ªùi nh·∫Øc c·ªßa n√≥.

```javascript
const CI = fountCharCI;

CI.beforeEach(async () => {
	await CI.char.interfaces.config.SetData({ AIsource: 'CI' });
});

CI.test('H√†m: <web-browse>', async () => {
	const { router, url, root } = CI.context.http;
	const webContent = '<html><body><p>ƒê√¢y l√† m·ªôt ƒëo·∫°n vƒÉn th·ª≠ nghi·ªám.</p></body></html>';

	router.get(root, (req, res) => res.send(webContent));

	const result = await CI.runOutput([
		// 1. AI quy·∫øt ƒë·ªãnh duy·ªát trang
		`<web-browse><url>${url}</url></web-browse>`,

		// 2. S·ª≠ d·ª•ng m·ªôt h√†m ƒë·ªÉ x√°c th·ª±c b∆∞·ªõc trung gian v√† cung c·∫•p c√¢u tr·∫£ l·ªùi ti·∫øp theo c·ªßa AI
		async (midResult) => {
			// Kh·∫≥ng ƒë·ªãnh: Ki·ªÉm tra xem l·ªùi nh·∫Øc ƒë∆∞·ª£c g·ª≠i ƒë·∫øn AI c√≥ bao g·ªìm n·ªôi dung trang web kh√¥ng
			const systemLog = midResult.prompt_struct.find(log => log.role === 'tool');
			CI.assert(systemLog.content.includes('ƒê√¢y l√† m·ªôt ƒëo·∫°n vƒÉn th·ª≠ nghi·ªám'), 'N·ªôi dung web kh√¥ng c√≥ trong l·ªùi nh·∫Øc.');

			// Tr·∫£ v·ªÅ c√¢u tr·∫£ l·ªùi cu·ªëi c√πng c·ªßa AI
			return 'ƒêo·∫°n vƒÉn n√≥i: ƒê√¢y l√† m·ªôt ƒëo·∫°n vƒÉn th·ª≠ nghi·ªám.';
		}
	]);

	// Kh·∫≥ng ƒë·ªãnh: Ki·ªÉm tra xem n·ªôi dung cu·ªëi c√πng ƒë∆∞·ª£c cung c·∫•p cho ng∆∞·ªùi d√πng c√≥ ch√≠nh x√°c kh√¥ng
	CI.assert(result.content.includes('ƒêo·∫°n vƒÉn n√≥i'), 'C√¢u tr·∫£ l·ªùi cu·ªëi c√πng kh√¥ng ch√≠nh x√°c.');
});
```

## V·∫´n c·∫£m th·∫•y l·∫°c l√µng?

H√£y xem c√°ch vai tr√≤ fount ƒë·∫ßu ti√™n tr√™n th·∫ø gi·ªõi, [`Gentian`](https://github.com/steve02081504/GentianAphrodite/blob/master/.github/workflows/CI.mjs), th·ª±c hi·ªán ƒëi·ªÅu ƒë√≥!
